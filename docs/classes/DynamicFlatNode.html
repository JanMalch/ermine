<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Documentation · Ermine</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/laravel.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Documentation · Ermine</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li>DynamicFlatNode</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/view/file-tree/tree.control.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#associatedOids">associatedOids</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#expandable">expandable</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#isLoading">isLoading</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#item">item</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#level">level</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#oid">oid</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#path">path</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#type">type</a>
                            </li>
                        </ul>
                    </td>
                </tr>






        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(item: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, oid: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, type: "blob" | "tree", level: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, expandable, path: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, isLoading)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="10" class="link-to-prism">src/app/view/file-tree/tree.control.ts:10</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>item</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>oid</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>type</td>
                                                  
                                                        <td>
                                                                    <code>&quot;blob&quot; | &quot;tree&quot;</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>level</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>expandable</td>
                                                  
                                                        <td>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>path</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>isLoading</td>
                                                  
                                                        <td>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="associatedOids"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            associatedOids</b>
                            <a href="#associatedOids"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>string[]</code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>[]</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="10" class="link-to-prism">src/app/view/file-tree/tree.control.ts:10</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="expandable"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            expandable</b>
                            <a href="#expandable"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>false</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="17" class="link-to-prism">src/app/view/file-tree/tree.control.ts:17</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="isLoading"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            isLoading</b>
                            <a href="#isLoading"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>false</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="19" class="link-to-prism">src/app/view/file-tree/tree.control.ts:19</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="item"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            item</b>
                            <a href="#item"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="13" class="link-to-prism">src/app/view/file-tree/tree.control.ts:13</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="level"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            level</b>
                            <a href="#level"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>1</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="16" class="link-to-prism">src/app/view/file-tree/tree.control.ts:16</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="oid"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            oid</b>
                            <a href="#oid"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>null</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="14" class="link-to-prism">src/app/view/file-tree/tree.control.ts:14</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="path"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            path</b>
                            <a href="#path"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="18" class="link-to-prism">src/app/view/file-tree/tree.control.ts:18</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Public</span>
                            type</b>
                            <a href="#type"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code>&quot;blob&quot; | &quot;tree&quot;</code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>null</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="15" class="link-to-prism">src/app/view/file-tree/tree.control.ts:15</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>







    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { CollectionViewer, DataSource, SelectionChange } from &#x27;@angular/cdk/collections&#x27;;
import { FlatTreeControl } from &#x27;@angular/cdk/tree&#x27;;
import { Injectable } from &#x27;@angular/core&#x27;;
import { BehaviorSubject, merge, Observable } from &#x27;rxjs&#x27;;
import { map } from &#x27;rxjs/operators&#x27;;
import { Entry, TreeOidQuery } from &#x27;@graphql/tree-oid.query&#x27;;
import { Repository } from &#x27;@core/models&#x27;;

export class DynamicFlatNode {
  public associatedOids: string[] &#x3D; [];

  constructor(
    public item: string,
    public oid: string &#x3D; null,
    public type: &#x27;blob&#x27; | &#x27;tree&#x27; &#x3D; null,
    public level &#x3D; 1,
    public expandable &#x3D; false,
    public path: string &#x3D; &#x27;&#x27;,
    public isLoading &#x3D; false
  ) {}
}

/**
 * Database for dynamic data. When expanding a node in the tree, the data source will need to fetch
 * the descendants data from the database.
 */
export class DynamicDatabase {
  dataMap &#x3D; new Map&lt;string, DynamicFlatNode[]&gt;();
  private repository: Repository;
  private treeOidQuery: TreeOidQuery;

  init(repository: Repository, treeOidQuery: TreeOidQuery) {
    this.repository &#x3D; repository;
    this.treeOidQuery &#x3D; treeOidQuery;
  }

  async getChildren(
    oid: string,
    level: number,
    parent: string
  ): Promise&lt;DynamicFlatNode[] | undefined&gt; {
    if (!this.dataMap.has(oid)) {
      const entries &#x3D; await this.fetchEntries(oid);
      let nodes: DynamicFlatNode[];
      if (entries.length &#x3D;&#x3D;&#x3D; 1) {
        const { object, name, type } &#x3D; entries[0];
        if (type &#x3D;&#x3D;&#x3D; &#x27;tree&#x27;) {
          nodes &#x3D; [await this.chainSingleChildren(object.oid, name, level, parent)];
        }
      }
      if (!nodes) {
        nodes &#x3D; entries.map(e &#x3D;&gt; {
          const isDir &#x3D; e.type &#x3D;&#x3D;&#x3D; &#x27;tree&#x27;;
          return new DynamicFlatNode(e.name, e.object.oid, e.type, level + 1, isDir, parent);
        });
      }
      this.dataMap.set(oid, nodes);
    }
    return Promise.resolve(this.dataMap.get(oid));
  }

  async chainSingleChildren(
    oid: string,
    name: string,
    level: number,
    parent: string
  ): Promise&lt;DynamicFlatNode | undefined&gt; {
    const collectedOids &#x3D; [oid];
    const entry: Entry &#x3D; {
      name,
      type: &#x27;tree&#x27;,
      object: {
        oid
      }
    };
    while (true) {
      const [firstEntry, ...remainder] &#x3D; await this.fetchEntries(oid);
      const hasOneChild &#x3D; firstEntry.type &#x3D;&#x3D;&#x3D; &#x27;tree&#x27; &amp;&amp; remainder.length &#x3D;&#x3D;&#x3D; 0;
      if (!hasOneChild) {
        break;
      }
      oid &#x3D; firstEntry.object.oid;
      collectedOids.push(oid);
      entry.name +&#x3D; &#x60;/${firstEntry.name}&#x60;;
      entry.object.oid &#x3D; oid;
    }
    const node &#x3D; new DynamicFlatNode(
      entry.name,
      entry.object.oid,
      entry.type,
      level + 1,
      true,
      parent
    );
    collectedOids.pop();
    node.associatedOids &#x3D; [...collectedOids];
    return Promise.resolve(node);
  }

  areChildrenFetched(oid: string): boolean {
    return this.dataMap.has(oid);
  }

  private async fetchEntries(oid: string): Promise&lt;Entry[]&gt; {
    return this.treeOidQuery
      .fetchMapped({
        name: this.repository.name,
        owner: this.repository.owner,
        oid
      })
      .toPromise();
  }

  isExpandable(node: string): boolean {
    return this.dataMap.has(node);
  }
}

/**
 * File database, it can build a tree structured Json object from string.
 * Each node in Json object represents a file or a directory. For a file, it has filename and type.
 * For a directory, it has filename and children (a list of files or directories).
 * The input will be a json object string, and the output is a list of &#x60;FileNode&#x60; with nested
 * structure.
 */
@Injectable()
export class DynamicDataSource implements DataSource&lt;DynamicFlatNode&gt; {
  dataChange &#x3D; new BehaviorSubject&lt;DynamicFlatNode[]&gt;([]);

  get data(): DynamicFlatNode[] {
    return this.dataChange.value;
  }

  set data(value: DynamicFlatNode[]) {
    this.treeControl.dataNodes &#x3D; value;
    this.dataChange.next(value);
  }

  constructor(
    private treeControl: FlatTreeControl&lt;DynamicFlatNode&gt;,
    private database: DynamicDatabase
  ) {}

  connect(collectionViewer: CollectionViewer): Observable&lt;DynamicFlatNode[]&gt; {
    this.treeControl.expansionModel.changed.subscribe(
      (change: SelectionChange&lt;DynamicFlatNode&gt;) &#x3D;&gt; {
        if (change.added || change.removed) {
          this.handleTreeControl(change);
        }
      }
    );

    return merge(collectionViewer.viewChange, this.dataChange).pipe(map(() &#x3D;&gt; this.data));
  }

  /** Handle expand/collapse behaviors */
  handleTreeControl(change: SelectionChange&lt;DynamicFlatNode&gt;) {
    if (change.added) {
      change.added.forEach(async node &#x3D;&gt; await this.toggleNode(node, true));
    }
    if (change.removed) {
      change.removed
        .slice()
        .reverse()
        .forEach(node &#x3D;&gt; this.toggleNode(node, false));
    }
  }

  /**
   * Toggle the node, remove from display list
   */
  async toggleNode(node: DynamicFlatNode, expand: boolean) {
    const parentPath &#x3D; node.path.length &#x3D;&#x3D;&#x3D; 0 ? node.item : node.path + &#x27;/&#x27; + node.item;
    const children &#x3D; await this.database.getChildren(node.oid, node.level, parentPath);
    const index &#x3D; this.data.indexOf(node);
    if (!children || index &lt; 0) {
      // If no children, or cannot find the node, no op
      return;
    }

    if (expand) {
      const nodes &#x3D; [...children];
      this.data.splice(index + 1, 0, ...nodes);
      this.treeControl.expand(node);
    } else {
      this.treeControl.collapseDescendants(node);
      let count &#x3D; 0;
      for (
        let i &#x3D; index + 1;
        i &lt; this.data.length &amp;&amp; this.data[i].level &gt; node.level;
        i++, count++
      ) {}
      this.data.splice(index + 1, count);
    }

    // notify the change, distinct by OID
    this.data &#x3D; this.data.filter((v, i, a) &#x3D;&gt; a.findIndex(n &#x3D;&gt; n.oid &#x3D;&#x3D;&#x3D; v.oid) &#x3D;&#x3D;&#x3D; i);
  }

  disconnect(collectionViewer: CollectionViewer): void {}
}
</code></pre>
    </div>
</div>



                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'DynamicFlatNode.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
